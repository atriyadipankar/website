<form id="signupForm" novalidate>
    <div class="mb-3">
        <label for="name" class="form-label">Full Name</label>
        <input type="text" class="form-control" id="name" name="name" required>
        <div class="invalid-feedback"></div>
    </div>
    
    <div class="mb-3">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" class="form-control" id="email" name="email" required>
        <div class="invalid-feedback"></div>
    </div>
    
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input type="password" class="form-control" id="password" name="password" required>
        <div class="form-text">Password must be at least 6 characters long.</div>
        <div class="invalid-feedback"></div>
    </div>
    
    <div class="mb-3">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
        <div class="invalid-feedback"></div>
    </div>
    
    <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="agreeTerms" required>
        <label class="form-check-label" for="agreeTerms">
            I agree to the <a href="#" class="auth-link">Terms of Service</a> and 
            <a href="#" class="auth-link">Privacy Policy</a>
        </label>
        <div class="invalid-feedback"></div>
    </div>
    
    <div class="d-grid">
        <button type="submit" class="btn btn-primary" id="signupBtn">
            <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
            Create Account
        </button>
    </div>
    
    <div class="text-center mt-3">
        <p class="mb-0">Already have an account? 
            <a href="/auth/login" class="auth-link">Login here</a>
        </p>
    </div>
</form>

<script>
document.getElementById('signupForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const btn = document.getElementById('signupBtn');
    const spinner = btn.querySelector('.spinner-border');
    
    // Clear previous validation
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    
    // Client-side validation
    const password = form.password.value;
    const confirmPassword = form.confirmPassword.value;
    
    if (password !== confirmPassword) {
        const confirmField = form.confirmPassword;
        confirmField.classList.add('is-invalid');
        confirmField.nextElementSibling.textContent = 'Passwords do not match';
        return;
    }
    
    if (!form.agreeTerms.checked) {
        const agreeField = form.agreeTerms;
        agreeField.classList.add('is-invalid');
        agreeField.parentElement.querySelector('.invalid-feedback').textContent = 'You must agree to the terms';
        return;
    }
    
    // Show loading
    btn.disabled = true;
    spinner.classList.remove('d-none');
    
    try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        const response = await fetch('/auth/signup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast('Account created successfully! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } else {
            if (result.errors) {
                // Handle validation errors
                result.errors.forEach(error => {
                    const field = form.querySelector(`[name="${error.path || error.param}"]`);
                    if (field) {
                        field.classList.add('is-invalid');
                        const feedback = field.nextElementSibling;
                        if (feedback && feedback.classList.contains('invalid-feedback')) {
                            feedback.textContent = error.msg || error.message;
                        } else {
                            // For checkboxes, find the invalid-feedback in parent
                            const parentFeedback = field.parentElement.querySelector('.invalid-feedback');
                            if (parentFeedback) {
                                parentFeedback.textContent = error.msg || error.message;
                            }
                        }
                    }
                });
            } else {
                showToast(result.message || 'Signup failed', 'danger');
            }
        }
    } catch (error) {
        console.error('Signup error:', error);
        showToast('Network error. Please try again.', 'danger');
    } finally {
        btn.disabled = false;
        spinner.classList.add('d-none');
    }
});

// Real-time password confirmation validation
document.getElementById('confirmPassword').addEventListener('input', function() {
    const password = document.getElementById('password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && password !== confirmPassword) {
        this.classList.add('is-invalid');
        this.nextElementSibling.textContent = 'Passwords do not match';
    } else {
        this.classList.remove('is-invalid');
    }
});
</script>

